<script>
  document.getElementById("chat-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const query = document.getElementById("query").value;
    const errorBox = document.getElementById("error");
    errorBox.innerText = "";

    // 建一個結果顯示區（如果沒有）
    let resultBox = document.getElementById("result");
    if (!resultBox) {
      resultBox = document.createElement("div");
      resultBox.id = "result";
      resultBox.style.marginTop = "20px";
      resultBox.style.fontSize = "20px";
      document.body.appendChild(resultBox);
    }
    resultBox.innerHTML = "處理中…";

    try {
      const response = await fetch("https://hungming.app.n8n.cloud/webhook/01ea6ee0-8db7-4bad-994f-f43191bf58b8", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Accept": "application/json"
        },
        body: `query=${encodeURIComponent(query)}`
      });

      if (!response.ok) {
        throw new Error(`伺服器錯誤：${response.status}`);
      }

      // 先把原始字串拿到
      const raw = await response.text();
      if (!raw || raw.trim() === "") {
        throw new Error("回傳內容為空");
      }

      // 嘗試解析 JSON；失敗就當純文字顯示
      let data;
      try {
        data = JSON.parse(raw);
      } catch {
        resultBox.textContent = raw;
        return;
      }

      const result = data && data.result ? String(data.result) : "";

      if (!result) {
        resultBox.textContent = "沒有回傳內容";
        return;
      }

      // 如果是 Markdown 圖片語法：![...](url)
      const mdImgMatch = result.match(/!\[[^\]]*\]\(([^)]+)\)/);
      if (mdImgMatch) {
        const img = document.createElement("img");
        img.src = mdImgMatch[1];
        img.alt = "chart";
        img.style.maxWidth = "100%";
        resultBox.innerHTML = "";
        resultBox.appendChild(img);
        return;
      }

      // 如果直接是 QuickChart 圖片網址
      if (/^https?:\/\/.*quickchart\.io\/chart/.test(result)) {
        const img = document.createElement("img");
        img.src = result;
        img.alt = "chart";
        img.style.maxWidth = "100%";
        resultBox.innerHTML = "";
        resultBox.appendChild(img);
        return;
      }

      // 其他一般文字
      resultBox.textContent = result;

    } catch (err) {
      errorBox.innerText = "錯誤：" + err.message;
      const resultBox = document.getElementById("result");
      if (resultBox) resultBox.innerHTML = "";
    }
  });
</script>
