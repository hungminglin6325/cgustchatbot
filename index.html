<script>
  const form = document.getElementById("chat-form");
  const input = document.getElementById("query");
  const errorBox = document.getElementById("error");

  // 在輸入框下方加一個顯示區塊
  const resultBox = document.createElement('div');
  resultBox.id = 'result';
  resultBox.style.marginTop = '20px';
  resultBox.style.fontSize = '20px';
  document.body.appendChild(resultBox);

  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    errorBox.innerText = "";
    resultBox.innerHTML = "處理中…";

    try {
      const response = await fetch("https://hungming.app.n8n.cloud/webhook/01ea6ee0-8db7-4bad-994f-f43191bf58b8", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Accept": "application/json"
        },
        body: `query=${encodeURIComponent(input.value)}`
      });

      if (!response.ok) {
        throw new Error(`伺服器錯誤：${response.status}`);
      }

      const ct = response.headers.get("content-type") || "";

      if (ct.includes("application/json")) {
        let data;
        try {
          data = await response.json(); // 這裡若 body 空會丟錯
        } catch (parseErr) {
          // 後端偶發回空內容，保底再取純文字
          const fallbackText = await response.text();
          if (fallbackText && fallbackText.trim().length > 0) {
            resultBox.textContent = fallbackText;
            return;
          }
          throw new Error("回傳為 JSON 但內容為空");
        }

        // 顯示結果（支援圖表 URL 或 Markdown 圖片語法）
        const result = data.result ?? "";
        if (!result) {
          resultBox.textContent = "沒有回傳內容";
          return;
        }

        // 如果是 Markdown 圖片語法：![...](url)
        const mdImgMatch = result.match(/!\[[^\]]*\]\(([^)]+)\)/);
        if (mdImgMatch) {
          const img = document.createElement('img');
          img.src = mdImgMatch[1];
          img.alt = 'chart';
          img.style.maxWidth = '100%';
          resultBox.innerHTML = "";
          resultBox.appendChild(img);
        } else if (/^https?:\/\/.*quickchart\.io\/chart/.test(result)) {
          // 直接回 QuickChart 連結也支援
          const img = document.createElement('img');
          img.src = result;
          img.alt = 'chart';
          img.style.maxWidth = '100%';
          resultBox.innerHTML = "";
          resultBox.appendChild(img);
        } else {
          // 其他一般文字
          resultBox.textContent = result;
        }

      } else {
        // 非 JSON：就當作純文字顯示
        const text = await response.text();
        resultBox.textContent = text || "回傳內容不是 JSON（且沒有文字）";
      }
    } catch (err) {
      errorBox.innerText = "錯誤：" + err.message;
      resultBox.innerHTML = "";
    }
  });
</script>
